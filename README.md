如何以有限的磁盘空间来存储无限膨胀的账本数据，是区块链数据治理领域的关键问题之一。全量数据服务组件Data-Stash用于解决账本和磁盘之间的矛盾。通过为节点生成全量备份作为后备保障，使节点便可以放心地进行数据裁剪，而不必担心数据丢失。Data-Stash还可以用于节点快速同步、监管审计等场景。



# 1. 关键特性

* 节点账本全量备份

全量数据服务拥有将节点账本完整备份到第三方存储的能力，从而可以满足多方面的需求，包括节点数据裁剪、快速同步、查询等。

![](https://data-doc.readthedocs.io/zh_CN/dev/_images/backup.png)

* 多维度账本校验

全量数据服务在读取某节点的日志后，会进行多维度的校验，以防止节点账本信息被损害、被篡改、共识系统异常等情况。

* 备份数据可信存储

每次处理完成一个区块，全量数据服务都会为此时刻的全量备份生成一个哈希值作为检查点。该检查点用于为存储增信，适用于全量备份库之间的校验等场景。

* 断点续传

我们设计了断点续传机制，我们会持续记录解析的进度，每一次运行的时候都会从上一次断点处运行，而不会重新开始。

* 易于使用

使用者只需要做少量的配置，就可以运行。可以通过jar包直接运行，也可以通过bash脚本启动。

# 2. 场景

* 通过裁剪实现瘦身

随着时间的推移，节点会积累越来越多的账本数据，如果账本的体积不受控制的增长，最终会把节点所在服务的磁盘侵蚀殆尽，导致整个节点不可用。运维人员可以使用全量数据服务来为节点瘦身，首先准备好一个容量充足的第三方数据库，然后运行全量数据服务将账本导入到该数据库中实现备份，这样就可以删除本地的账本数据了。

* 通过”神同步”实现迁移

在区块链业务运行的时候，经常有节点迁移或升级的需求。例如，服务器因为某些故障需要被下线回收，或者需要更换磁盘，这个时候上面的数据就都没有了，而重新运行节点又需要从区块链网络里同步数据，若待同步数据很大，例如几十、几百G，就会使得数据恢复时间冗长，甚至造成长时间业务不可用。现在，若对旧节点了做了全量数据备份，运维人员可以直接让节点将全量备份作为自己的账本，这样就实现了秒级的”神同步”，免去了冗长的同步过程。

* 监管、审计、追溯

对于监管而言，要求账本数据完整、可查询。但区块链自身的账本数据库不一定满足这一点，例如出于节点瘦身、数据分片等需求，节点上可能仅存储部分账本数据；出于性能的需要，区块链会选择rocksdb等数据库，但这类数据库并不适合查询。此时，监管方可以对某个节点运行全量数据服务导出全量备份，该全量备份是完整的，同时由于我们采用了关系型数据库，从而易于查询，因此可以满足监管需求。此外，在全量备份过程中，会采用多维度的校验机制，这样可以防止节点运维恶意修改账本信息欺骗监管。

# 3. 快速开始

快速开始请参见[文档](https://data-doc.readthedocs.io/zh_CN/latest/docs/WeBankBlockchain-Data-Stash/index.html)。

# 4. 架构设计

![](https://data-doc.readthedocs.io/zh_CN/dev/_images/architecture.png)
更多请见[文档](https://data-doc.readthedocs.io/zh_CN/dev/docs/WeBankBlockchain-Data-Stash/design.html)。



